#!/usr/bin/python
import dbus, os

if not os.getenv("DISPLAY"):
  # Get the ConsoleKit manager
  bus = dbus.SystemBus()
  manager_obj = bus.get_object('org.freedesktop.ConsoleKit', 
'/org/freedesktop/ConsoleKit/Manager')
  manager = dbus.Interface(manager_obj, 
'org.freedesktop.ConsoleKit.Manager')
  
  # For each of my sessions..
  for ssid in manager.GetSessionsForUnixUser(os.getuid()):
    obj = bus.get_object('org.freedesktop.ConsoleKit', ssid)
    session = dbus.Interface(obj, 'org.freedesktop.ConsoleKit.Session')
    print dir(session)
    # Get the X11 display name
    dpy = session.GetX11Display()
    if dpy:
      # If we have a display, set the environment variable
      os.putenv("DISPLAY", dpy);
      break

import gobject, gnomekeyring

gobject.set_application_name("mutt")

def keyring(user, host, proto):
  if "@" not in user:
  	user = user+"@gmail.com"
  try:
    keys = gnomekeyring.find_network_password_sync(user=user, server=host,
                                                 protocol=proto.rstrip("s"))
  except gnomekeyring.NoMatchError:
    user = user.split("@", 1)[0]
    keys = gnomekeyring.find_network_password_sync(user=user, server=host,
                                                 protocol=proto.rstrip("s"))
      
  # First one will do nicely thanks
  return keys[0]["password"]

import sys
try:
  print keyring(*sys.argv[1:])
except TypeError:
  print >> sys.stderr, 'usage: ./.mutt-password user host protocol'
